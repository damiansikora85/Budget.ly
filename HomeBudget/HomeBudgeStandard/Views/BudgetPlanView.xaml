<?xml version="1.0" encoding="UTF-8"?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms" 
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:oxy="clr-namespace:OxyPlot.Xamarin.Forms;assembly=OxyPlot.Xamarin.Forms"
             xmlns:converters="clr-namespace:HomeBudget.Converters"
             xmlns:sf="clr-namespace:Syncfusion.SfDataGrid.XForms;assembly=Syncfusion.SfDataGrid.XForms"
             xmlns:data="clr-namespace:Syncfusion.Data;assembly=Syncfusion.Data.Portable"
             xmlns:utils="clr-namespace:HomeBudget.Utils"
             x:Class="HomeBudgeStandard.Views.BudgetPlanView"
             Title="Planowanie">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:ChartLabelVisibilityConverter x:Key="VisibilityConverter" />
            <converters:CurrencyValueConverter x:Key="CurrencyValueConverter" />
            <converters:BudgetCategorySortComparer x:Key="SortComparer"/>
            <utils:CurrencyDataGridHeader x:Key="currencyDataGridHeader"/>
            <DataTemplate x:Key="dataMarkerTemplate">
                <StackLayout BackgroundColor="{Binding Interior}">
                    <!--IsVisible="{Binding Subcat.Value, Converter=StaticResource VisibilityConverter}">-->
                    <Label Text="{Binding Name}"/>
                </StackLayout>
            </DataTemplate>

        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="2*"/>
        </Grid.RowDefinitions>

        <StackLayout Orientation="Horizontal" HorizontalOptions="Center" >
            <Button x:Name="PreviousMonthButton" BackgroundColor="Transparent" Text="&#xf104;" Clicked="OnPrevMonth">
                <Button.FontFamily>
                    <OnPlatform x:TypeArguments="x:String" Android="Font Awesome 5 Free-Solid-900.otf#Font Awesome 5 Free Solid" />
                </Button.FontFamily>
            </Button>
            <Label Text="{Binding Date}" HorizontalTextAlignment="Center" FontSize="Large" VerticalTextAlignment="Center"/>
            <Button x:Name="NextMonthButton" BackgroundColor="Transparent" Text="&#xf105;" Clicked="OnNextMonth">
                <Button.FontFamily>
                    <OnPlatform x:TypeArguments="x:String" Android="Font Awesome 5 Free-Solid-900.otf#Font Awesome 5 Free Solid" />
                </Button.FontFamily>
            </Button>
        </StackLayout>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <Label x:Name="ExpensesChartSwitch" Text="Wydatki" FontAttributes="Bold" Rotation="270" Grid.Row="0" VerticalTextAlignment="Center"/>
                <Label x:Name="IncomeChartSwitch" Text="Dochody" FontAttributes="Bold" Rotation="270" Grid.Row="1" VerticalTextAlignment="Center"/>

            </Grid>

            <utils:BudgetChart x:Name="chartExpense" Grid.Column="1" />
            <utils:BudgetChart x:Name="chartIncome" Grid.Column="1" />
            
            <!--<charts:SfChart x:Name="chartExpense" Grid.Column="1" VerticalOptions="FillAndExpand" HorizontalOptions="StartAndExpand">
                <charts:SfChart.Legend>
                    <charts:ChartLegend DockPosition="Right"/>
                </charts:SfChart.Legend>

                <charts:PieSeries ItemsSource="{Binding ExpensesData}" XBindingPath="Name" YBindingPath="Category.TotalValues" ListenPropertyChange="True">
                </charts:PieSeries>
            </charts:SfChart>

            <charts:SfChart x:Name="chartIncome" Grid.Column="1" VerticalOptions="FillAndExpand" HorizontalOptions="StartAndExpand" IsVisible="False">
                <charts:SfChart.Legend>
                    <charts:ChartLegend DockPosition="Right"/>
                </charts:SfChart.Legend>

                <charts:PieSeries ItemsSource="{Binding IncomesData}" XBindingPath="Name" YBindingPath="Subcat.Value" ListenPropertyChange="True">
                </charts:PieSeries>
            </charts:SfChart>

            <ContentView x:Name="emptyChartView" Grid.Column="1" IsVisible="False"/>-->

        </Grid>


        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3*"/>
                <ColumnDefinition Width="2*"/>
            </Grid.ColumnDefinitions>
            <sf:SfDataGrid x:Name="DataGrid" EnableDataVirtualization="True" ItemsSource="{Binding Budget}" AutoGenerateColumns="False" 
                           GroupCaptionTextFormat="{}{Key}" AutoExpandGroups="False" AllowGroupExpandCollapse="true" LiveDataUpdateMode="AllowSummaryUpdate" 
                           FrozenColumnsCount="2" CurrentCellEndEdit="DataGrid_CurrentCellEndEdit" HorizontalOptions="CenterAndExpand" 
                           SelectionMode="SingleDeselect" NavigationMode="Cell" >
                <sf:SfDataGrid.GroupColumnDescriptions>
                    <sf:GroupColumnDescription ColumnName="Category.Name" />
                </sf:SfDataGrid.GroupColumnDescriptions>

                <sf:SfDataGrid.SortComparers>
                    <data:SortComparer Comparer="{StaticResource SortComparer}" PropertyName="Category.Name"/>
                </sf:SfDataGrid.SortComparers>

                <sf:SfDataGrid.CaptionSummaryRow>
                    <sf:GridGroupSummaryRow Title="{}{Key}: {Total}" ShowSummaryInRow="True">
                        <sf:GridGroupSummaryRow.SummaryColumns>
                            <sf:GridSummaryColumn Name="Total"
                                      Format="{}{Currency}"
                                      MappingName="Subcat.Value"
                                      CustomAggregate="{StaticResource currencyDataGridHeader}"
                                      SummaryType="Custom"/>
                        </sf:GridGroupSummaryRow.SummaryColumns>
                    </sf:GridGroupSummaryRow>
                </sf:SfDataGrid.CaptionSummaryRow>

                <sf:SfDataGrid.Columns>
                    <sf:GridTextColumn MappingName="Subcat.Name" HeaderText="Kategoria" HeaderFontAttribute="Bold" ColumnSizer="Star">
                        <sf:GridTextColumn.CellStyle>
                            <Style TargetType="sf:GridCell">
                                <Setter Property="BackgroundColor" Value="#EAEAEA" />
                            </Style>
                        </sf:GridTextColumn.CellStyle>
                    </sf:GridTextColumn>

                    <sf:GridNumericColumn ColumnSizer="LastColumnFill" MappingName="SubcatPlanned.Value" HeaderFontAttribute="Bold" FontAttribute="Bold" DisplayBinding="{Binding SubcatPlanned.Value, Converter={StaticResource CurrencyValueConverter}}" HeaderText="Suma" AllowEditing="True"/>
                </sf:SfDataGrid.Columns>
            </sf:SfDataGrid>
            <Button Grid.Column="1" Text="Użyj w kolejnych miesiącach" VerticalOptions="End" BackgroundColor="DodgerBlue" TextColor="White" Margin="12,12" Clicked="OnSave"/>
        </Grid>

    </Grid>
</ContentPage>